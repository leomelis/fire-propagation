<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://code.jquery.com/jquery-migrate-1.1.1.min.js"></script>
    <script type="text/javascript" src="raphael-min.js"></script>

    <!-- Fix rendering issue -->
    <style> svg {shape-rendering: crispEdges; } </style>

    <script>
        var paper;

        var horizontal_size = 20;
        var vertical_size = 20;
        var dim = 20;

        var ox = 0;
        var oy = 10;
        var wind_strength = 5;
        var wind_direction = 0;
        var wind_amplitude = 90;

        var grid = [];

        var paper_width  = horizontal_size*dim;
        var paper_height = vertical_size*dim;

        var colors = {
            "fire":"red",
            "firewall":"black",
            "tree":"beige",
            "pine":"green"
        }

        function fix_y(y){
            return paper_height - y - dim;
        }

        function create_square(x, y, type){
            x = x*dim;
            y = fix_y(y*dim);

            var c = paper.rect(x, y, dim, dim);
            c.attr("fill", colors[type]);
        }

        function propagate_fire(v,wd,wa){
            for (var i=0; i<horizontal_size; i++) {
                for (var j=0; j<vertical_size; j++) {
                    types = grid[i][j];
                    type = types[types.length - 2];

                    if (type == "fire") {
                        propagate_fire_origin(i,j,v,wd,wa);
                    }
                }
            }
        }
        function propagate_fire_origin(x, y, v, wd, wa){
            for (i=-v; i<v+1; i++){
                for(j=-v; j<v+1; j++){
                    x_ = x+i;
                    y_ = y+j;

                    alpha = wd;
                    beta = wa;
                    alpha_lower = alpha - beta/2;
                    alpha_upper = alpha + beta/2;

                    gamma = Raphael.angle(x_, y_, x, y);

                    // boolean
                    inside_wind =   ((alpha_lower     <= gamma) && (gamma <= alpha_upper)) ||
                                    ((alpha_lower+360 <= gamma) && (gamma <= alpha_upper+360)) ||
                                    ((alpha_lower-360 <= gamma) && (gamma <= alpha_upper-360));

                    // boolean
                    inside_circle = Math.sqrt(i*i + j*j) <= v;

                    if (inside_wind && inside_circle){
                        set_state(x+i, y+j,"fire");
                    }
                }
            }
        }

        function initialize_grid(){
            for (var i=0; i<horizontal_size; i++) {
                grid[i] = [];
                for (var j=0; j<vertical_size; j++) {
                    grid[i][j] = ["tree"];
                }
            }
        }

        function draw(){
            for (var i=0; i<horizontal_size; i++) {
                for (var j=0; j<vertical_size; j++) {
                    types = grid[i][j];
                    type = types[types.length - 1];
                    create_square(i,j,type);
                }
            }
        }

        function next_turn(){
            for (var i=0; i<horizontal_size; i++) {
                for (var j=0; j<vertical_size; j++) {
                    types = grid[i][j];
                    type = types[types.length - 1];
                    grid[i][j].push(type);
                }
            }
        }

        function get_state (x, y) {
            types = grid[x][y];
            type = types[types.length - 1];
            return type;
        }

        function set_state (x, y, type) {
            try {
                grid[x][y];
            }
            catch (err) {
                return
            }

            types = grid[x][y];
            if (typeof(types) != "undefined") {
                last = types.length -1;
                grid[x][y][last] = type;
            }
        }

        function setup_listeners(){
            $("#btn-next").click(function(){
                next_turn();
                propagate_fire(wind_strength, wind_direction, wind_amplitude);
                draw();
            });
        }

        $(document).ready(function(){
            setup_listeners();
            paper = Raphael(document.getElementById("notepad"), paper_width, paper_height);

            initialize_grid();
            set_state(ox,oy,"fire");
            draw();
        });
    </script>
</head>
<body>
    <input id="btn-next" type="button" value="next"/>
    <div id="notepad"></div>
</body>
</html>